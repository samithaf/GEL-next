# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
- main
stages:
- stage: prepare
  jobs:
  - job: run_prepare
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Bash@3
      inputs:
        targetType: 'inline'
        script: mkdir -p $(Build.SourcesDirectory)/dist/src && mkdir -p $(Build.SourcesDirectory)/dist/lib && echo '' >> $(Build.SourcesDirectory)/dist/lib/blank.txt && rsync -a --exclude={'**.git/','**test.*','**spec.*','**.vscode/','**.dist/','**README.md','**mock-data/','**mocks/'} $(Build.SourcesDirectory) $(Build.SourcesDirectory)/dist 
    - task: CopyFiles@2
      displayName: 'Copy scripts'
      inputs:
        contents: 'dist/**'
        targetFolder: '$(Build.ArtifactStagingDirectory)'
        

    - publish: '$(Build.ArtifactStagingDirectory)/dist'
      displayName: 'Publish script'
      artifact: drop

# - stage: test
#   dependsOn: prepare
#   jobs:
#   - job: run_test
#     pool:
#       vmImage: 'ubuntu-latest'
#     steps:
#     - download: current
#       artifact: drop
#     - task: PowerShell@2
#       inputs:
#         filePath: '$(Pipeline.Workspace)\drop\test.ps1'
